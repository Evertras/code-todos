name: update-wiki
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  update:
    name: Update wiki
    runs-on: ubuntu-latest
    steps:
      - name: Get codebase
        uses: actions/checkout@v3
        with:
          repository: ${{github.repository}}
          path: repo
      - name: Get wiki
        uses: actions/checkout@v3
        with:
          repository: ${{github.repository}}.wiki
          path: wiki
      - name: Fetch CLI
        run: |
          # TODO: Better version handling
          curl -Lo cli.tar.gz https://github.com/Evertras/code-todos/releases/download/v0.1.2/code-todos_0.1.2_linux_amd64.tar.gz
          tar -xf cli.tar.gz
      - name: Update todos
        run: |
          cd wiki
          # TODO: Make a Github action out of this and previous step?
          echo "# TODOs" > todos.md
          echo "" >> todos.md
          echo "This file is generated by the Update wiki workflow.  Do not edit directly!" >> todos.md
          echo "" >> todos.md
          echo -n "Last updated: " >> todos.md
          date >> todos.md
          echo "" >> todos.md
          cd ../repo
          ../code-todos find --link-prefix https://github.com/Evertras/code-todos/tree/main internal cmd >> ../wiki/todos.md
      - name: Push to wiki
        run: |
          cd wiki
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git diff-index --quiet HEAD || git commit -m "Update todos" && git push

